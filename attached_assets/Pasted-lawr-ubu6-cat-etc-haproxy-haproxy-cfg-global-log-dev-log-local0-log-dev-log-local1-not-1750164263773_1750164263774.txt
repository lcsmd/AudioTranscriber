lawr@ubu6:~$ cat /etc/haproxy/haproxy.cfg
global
    log /dev/log local0
    log /dev/log local1 notice
    daemon
    maxconn 2048
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    pidfile /run/haproxy.pid

listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats realm Haproxy\ Statistics
    stats auth admin:apgar-66
    stats refresh 10s

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

frontend https_in
    bind *:443 ssl crt /etc/haproxy/certs/wildcard.pem ciphers HIGH:!aNULL:!MD5
    mode http
    log global
    option forwardfor
    option http-server-close
    http-request set-header X-Forwarded-Proto https
    http-request add-header X-Real-IP %[src]

    acl is_n8n hdr(host) -i n8n.lcs.ai
    acl is_nextcloud hdr(host) -i next.lcs.ai nextcloud.lcs.ai
    acl is_chat hdr(host) -i chat.lcs.ai
    acl is_hal hdr(host) -i hal.lcs.ai
    acl is_webmin hdr(host) -i webmin.lcs.ai
    acl is_nas hdr(host) -i nas.lcs.ai
    acl is_dash hdr(host) -i dash.lcs.ai
    acl is_ollama hdr(host) -i ollama.lcs.ai

    use_backend nextcloud_backend if is_nextcloud
    use_backend webmin_backend if is_webmin
    use_backend n8n_backend if is_n8n
    use_backend nas_backend if is_nas
    use_backend dash_backend if is_dash
    use_backend hal_backend if is_hal
    use_backend chat_backend if is_chat
    use_backend ollama_backend if is_ollama

    default_backend fallback_backend

frontend http_in
    bind *:80
    mode http
    log global
    acl from_openqm src 10.1.34.103
    acl host_openai hdr(host) -i openai.lcs.ai
    acl host_anthropic hdr(host) -i anthropic.lcs.ai

    http-request redirect scheme https code 301 if !from_openqm
    use_backend openai_backend if from_openqm host_openai
    use_backend anthropic_backend if from_openqm host_anthropic
    use_backend openai_backend if from_openqm host_openai

# ----------------------
# BACKENDS
# ----------------------

backend nextcloud_backend
    option http-server-close
    option forwardfor
    option httpchk GET /status.php
    http-request set-header X-Forwarded-Proto https
    server nextcloud 10.1.40.17:8080 check

backend webmin_backend
    option http-server-close
    option forwardfor
    server webmin 10.1.50.1:10000 check

backend n8n_backend
    option http-server-close
    option forwardfor
    server n8n 10.1.40.17:5678 check

backend nas_backend
    option http-server-close
    option forwardfor
    server nas 10.1.32.100:5001 ssl verify none

backend dash_backend
    option http-server-close
    option forwardfor
    server dash 10.1.100.1:31003 check

backend hal_backend
    option http-server-close
    option forwardfor
    server hal 10.1.50.2:3000 check

backend chat_backend
    option http-server-close
    option forwardfor
    server chat 10.1.40.17:3000 check

backend ollama_backend
    option http-server-close
    option forwardfor
    server ollama 10.1.10.20:11434 check

backend fallback_backend
    option http-server-close
    option forwardfor
    server fallback 127.0.0.1:8081 check

backend openai_backend
    server openai api.openai.com:443 ssl verify none sni str(openai.lcs.ai)

backend anthropic_backend
    server anthropic api.anthropic.com:443 ssl verify none sni str(anthropic.lcs.ai)
lawr@ubu6:~$ 