<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Transcriber</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }
        
        .upload-area.dragging {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .file-info {
            display: none;
            padding: 15px;
            background: #f0f2ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .file-info.visible {
            display: block;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .progress-section {
            display: none;
            margin-top: 30px;
        }
        
        .progress-section.visible {
            display: block;
        }
        
        .progress-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 40px;
            background: #e0e7ff;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .progress-details {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
        }
        
        .progress-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e7ff;
        }
        
        .progress-row:last-child {
            border-bottom: none;
        }
        
        .progress-label {
            font-weight: 600;
            color: #667eea;
        }
        
        .progress-value {
            color: #333;
        }
        
        .result-section {
            display: none;
            margin-top: 30px;
        }
        
        .result-section.visible {
            display: block;
        }
        
        .result-text {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Georgia', serif;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Audio Transcriber</h1>
            <p>Upload audio or video files for instant AI transcription</p>
        </div>
        
        <div class="card">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>Drop your file here or click to browse</h3>
                <p style="color: #64748b; margin-top: 10px;">Supports MP3, WAV, MP4, MOV up to 500MB</p>
                <input type="file" id="fileInput" accept="audio/*,video/*" style="display: none;">
            </div>
            
            <div class="file-info" id="fileInfo">
                <strong>Selected:</strong> <span id="fileName"></span> (<span id="fileSize"></span>)
            </div>
            
            <button class="btn btn-primary" id="transcribeBtn" disabled>
                <span id="btnText">Select a file to begin</span>
            </button>
            
            <div class="progress-section" id="progressSection">
                <div class="progress-header">
                    <span id="progressStatus">Processing...</span>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">
                        <span id="progressPercent">0%</span>
                    </div>
                </div>
                
                <div class="progress-details" id="progressDetails">
                    <div class="progress-row">
                        <span class="progress-label">Status:</span>
                        <span class="progress-value" id="statusText">Initializing...</span>
                    </div>
                    <div class="progress-row">
                        <span class="progress-label">File Duration:</span>
                        <span class="progress-value" id="durationText">Detecting...</span>
                    </div>
                    <div class="progress-row">
                        <span class="progress-label">Processed:</span>
                        <span class="progress-value" id="processedText">0:00</span>
                    </div>
                    <div class="progress-row">
                        <span class="progress-label">Remaining:</span>
                        <span class="progress-value" id="remainingText">Calculating...</span>
                    </div>
                    <div class="progress-row">
                        <span class="progress-label">Speed:</span>
                        <span class="progress-value" id="speedText">--</span>
                    </div>
                </div>
            </div>
            
            <div class="result-section" id="resultSection">
                <h3 style="margin-bottom: 15px; color: #10b981;">‚úÖ Transcription Complete!</h3>
                <div class="result-text" id="resultText"></div>
                <div class="action-buttons">
                    <button class="btn btn-success" id="downloadBtn">
                        üíæ Download Transcription
                    </button>
                    <button class="btn btn-secondary" id="newBtn">
                        üîÑ Transcribe Another
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentJobId = null;
        let pollInterval = null;
        let selectedFile = null;
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const transcribeBtn = document.getElementById('transcribeBtn');
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');
        
        // Upload area interactions
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');
            fileInput.files = e.dataTransfer.files;
            handleFileSelect();
        });
        
        fileInput.addEventListener('change', handleFileSelect);
        
        function handleFileSelect() {
            if (fileInput.files.length > 0) {
                selectedFile = fileInput.files[0];
                const sizeMB = (selectedFile.size / (1024 * 1024)).toFixed(2);
                
                document.getElementById('fileName').textContent = selectedFile.name;
                document.getElementById('fileSize').textContent = sizeMB + ' MB';
                fileInfo.classList.add('visible');
                
                transcribeBtn.disabled = false;
                document.getElementById('btnText').textContent = 'üöÄ Start Transcription';
            }
        }
        
        transcribeBtn.addEventListener('click', startTranscription);
        
        async function startTranscription() {
            if (!selectedFile) return;
            
            // Hide upload, show progress
            uploadArea.style.display = 'none';
            fileInfo.style.display = 'none';
            transcribeBtn.disabled = true;
            document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Processing...';
            progressSection.classList.add('visible');
            
            // Upload file
            const formData = new FormData();
            formData.append('audio_video_files', selectedFile);
            
            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.job_id) {
                    currentJobId = data.job_id;
                    startPolling();
                } else if (data.transcription) {
                    // Direct result
                    showResult(data.transcription.text);
                } else {
                    throw new Error('Invalid response');
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
                resetUI();
            }
        }
        
        function startPolling() {
            pollInterval = setInterval(checkProgress, 500);
        }
        
        async function checkProgress() {
            if (!currentJobId) return;
            
            try {
                const response = await fetch(`/api/job-status/${currentJobId}`);
                const data = await response.json();
                
                updateProgress(data);
                
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(pollInterval);
                    
                    if (data.status === 'completed' && data.result_text) {
                        showResult(data.result_text);
                    } else {
                        alert('Transcription failed: ' + (data.error_message || 'Unknown error'));
                        resetUI();
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }
        
        function updateProgress(data) {
            const percent = data.progress_percentage || 0;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            
            const message = data.status_message || 'Processing...';
            const lines = message.split('\n');
            document.getElementById('statusText').textContent = lines[0];
            
            // Parse time info from message
            if (lines.length > 1 && lines[1].includes('Duration:')) {
                const timeInfo = lines[1];
                const durationMatch = timeInfo.match(/Duration: ([^|]+)/);
                const processedMatch = timeInfo.match(/Processed: ([^|]+)/);
                const remainingMatch = timeInfo.match(/Remaining: ([^|]+)/);
                
                if (durationMatch) {
                    document.getElementById('durationText').textContent = durationMatch[1].trim();
                }
                if (processedMatch) {
                    document.getElementById('processedText').textContent = processedMatch[1].trim();
                }
                if (remainingMatch) {
                    document.getElementById('remainingText').textContent = remainingMatch[1].trim();
                }
                
                // Calculate speed
                if (data.processing_time && processedMatch) {
                    const procSec = parseTimeToSeconds(processedMatch[1].trim());
                    const elapsedSec = data.processing_time / 1000;
                    if (elapsedSec > 0 && procSec > 0) {
                        const speed = (procSec / elapsedSec).toFixed(1);
                        document.getElementById('speedText').textContent = speed + 'x realtime';
                    }
                }
            }
        }
        
        function parseTimeToSeconds(timeStr) {
            const parts = timeStr.match(/(\d+)h|(\d+)m|(\d+)s/g);
            if (!parts) return 0;
            
            let seconds = 0;
            parts.forEach(part => {
                if (part.includes('h')) seconds += parseInt(part) * 3600;
                if (part.includes('m')) seconds += parseInt(part) * 60;
                if (part.includes('s')) seconds += parseInt(part);
            });
            return seconds;
        }
        
        function showResult(text) {
            progressSection.classList.remove('visible');
            resultSection.classList.add('visible');
            document.getElementById('resultText').textContent = text;
            transcribeBtn.style.display = 'none';
        }
        
        function resetUI() {
            uploadArea.style.display = 'block';
            fileInfo.classList.remove('visible');
            progressSection.classList.remove('visible');
            resultSection.classList.remove('visible');
            transcribeBtn.disabled = false;
            transcribeBtn.style.display = 'block';
            document.getElementById('btnText').textContent = 'üöÄ Start Transcription';
            fileInput.value = '';
            selectedFile = null;
            currentJobId = null;
        }
        
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const text = document.getElementById('resultText').textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transcription_' + new Date().getTime() + '.txt';
            a.click();
        });
        
        document.getElementById('newBtn').addEventListener('click', resetUI);
    </script>
</body>
</html>
